<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP Platform</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<!-- MODALE LOGIN -->
<div id="loginModal" class="modal active">
    <div class="modal-content">
        <h2>Connexion</h2>
        <input type="text" id="loginPseudo" placeholder="Pseudo">
        <input type="password" id="loginCode" placeholder="Code Secret (Définitif)">
        <button onclick="login()">Entrer</button>
    </div>
</div>

<!-- MODALE PERSO -->
<div id="charModal" class="modal">
    <div class="modal-content">
        <h2>Créer un Personnage</h2>
        <input type="text" id="charName" placeholder="Nom complet">
        <input type="text" id="charRole" placeholder="Rôle / Titre">
        <input type="color" id="charColor" value="#ffffff">
        <textarea id="charBio" placeholder="Histoire / Description"></textarea>
        <label>Avatar:</label>
        <input type="file" id="charAvatarFile">
        <button onclick="saveCharacter()">Sauvegarder</button>
        <button class="secondary" onclick="closeModal('charModal')">Annuler</button>
    </div>
</div>

<!-- MODALE PROFIL -->
<div id="profileModal" class="modal">
    <div class="modal-content profile-view">
        <span class="close" onclick="closeModal('profileModal')">&times;</span>
        <img id="viewAvatar" src="" alt="Avatar">
        <h2 id="viewName"></h2>
        <p id="viewRole" class="role-badge"></p>
        <p class="meta">Joué par : <span id="viewPlayer"></span></p>
        <div class="bio-box" id="viewBio"></div>
        <button id="btnSubscribe" onclick="subscribeToChar()">S'abonner</button>
    </div>
</div>

<!-- APP LAYOUT -->
<div class="app-container" id="app" style="display:none;">
    
    <!-- GAUCHE : NAV -->
    <aside class="sidebar-left">
        <div class="user-profile">
            <h3 id="myPseudo">Guest</h3>
            <button onclick="logout()" class="btn-icon"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        
        <div class="nav-tabs">
            <button class="active" onclick="switchTab('chat')"><i class="fas fa-comments"></i> Chat</button>
            <button onclick="switchTab('feed')"><i class="fas fa-bullhorn"></i> Posts <span id="feedBadge" class="badge"></span></button>
        </div>

        <div class="section-title">Salons <i class="fas fa-plus admin-only" onclick="createRoomPrompt()"></i></div>
        <ul id="roomList"></ul>

        <div class="section-title">Mes Persos <i class="fas fa-plus" onclick="openCharModal()"></i></div>
        <div id="myCharList" class="char-grid"></div>
    </aside>

    <!-- CENTRE : MAIN -->
    <main class="main-content">
        
        <!-- VUE CHAT -->
        <div id="chatView">
            <header class="top-bar">
                <h3 id="currentRoomTitle"># Général</h3>
                <div class="char-selector-bar" id="charSelectorBar">
                    <!-- Avatars des persos pour switch rapide -->
                </div>
                <button class="toggle-chars" onclick="toggleCharBar()"><i class="fas fa-chevron-down"></i></button>
            </header>

            <div id="chatMessages" class="messages-area"></div>

            <div class="typing-indicator" id="typingIndicator"></div>

            <!-- Contextual Bar (DM, Reply, Media) -->
            <div id="contextBar" class="context-bar hidden">
                <span id="contextText"></span>
                <button onclick="clearContext()"><i class="fas fa-times"></i></button>
            </div>

            <div class="input-area">
                <div class="media-preview" id="mediaPreview"></div>
                
                <div class="input-tools">
                    <label for="mediaInput"><i class="fas fa-paperclip"></i></label>
                    <input type="file" id="mediaInput" hidden onchange="handleFileSelect(this)">
                    <button onclick="toggleRecord()" id="btnRecord"><i class="fas fa-microphone"></i></button>
                </div>
                
                <textarea id="msgInput" placeholder="Message en tant que..." oninput="emitTyping()" onkeydown="checkEnter(event)"></textarea>
                <button onclick="sendMessage()" class="btn-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- VUE FEED -->
        <div id="feedView" class="hidden">
            <header class="top-bar"><h3>Fil d'actualité</h3></header>
            
            <div class="post-creator">
                <textarea id="postContent" placeholder="Quoi de neuf ?"></textarea>
                <div class="post-tools">
                     <input type="file" id="postMediaInput" hidden>
                     <button onclick="document.getElementById('postMediaInput').click()"><i class="fas fa-image"></i> Média</button>
                     <select id="postCharSelect"></select>
                     <button onclick="sendPost()">Publier</button>
                </div>
            </div>

            <div id="feedContent" class="feed-scroll"></div>
        </div>
    </main>

    <!-- DROITE : USERS -->
    <aside class="sidebar-right">
        <div class="section-title">En ligne</div>
        <ul id="userList"></ul>
    </aside>

</div>

<script src="app.js"></script>
</body>
</html>
