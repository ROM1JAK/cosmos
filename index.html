<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP Verse Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* On garde ton super style moderne */
        :root { --bg-color: #1a1b1e; --sidebar-bg: #25262b; --input-bg: #2c2e33; --accent-color: #5c7cfa; --text-color: #c1c2c5; --msg-private-border: #ff6b6b; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        #sidebar { width: 300px; background-color: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        h3 { margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; font-size: 0.9rem; color: white;}
        .create-form { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        input, select { width: 100%; margin-bottom: 10px; padding: 12px; background: var(--input-bg); border: none; color: white; border-radius: 8px; box-sizing: border-box; outline: none;}
        .btn-primary { background-color: var(--accent-color); color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold;}
        .char-item { padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.02); border-radius: 8px; display: flex; align-items: center; }
        .mini-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        #chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: radial-gradient(circle at top right, #25262b 0%, #1a1b1e 40%); }
        #messages { flex: 1; overflow-y: scroll; padding: 20px 40px; display: flex; flex-direction: column; gap: 20px; }
        .message { display: flex; align-items: flex-start; max-width: 90%; }
        .message.private-msg { background: rgba(255, 107, 107, 0.05); border-left: 3px solid var(--msg-private-border); padding: 10px; border-radius: 0 8px 8px 0; }
        .avatar-img { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; margin-right: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .message-content { flex: 1; }
        .char-header { display: flex; align-items: baseline; margin-bottom: 5px; }
        .char-name { font-weight: 700; cursor: pointer; margin-right: 10px; font-size: 1.1em;}
        .timestamp { font-size: 0.75em; color: #666; }
        .private-badge { font-size: 0.7em; background: var(--msg-private-border); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 10px; font-weight: bold; }
        .text-body { line-height: 1.5; color: #e1e1e6; white-space: pre-wrap; }
        .chat-image { max-width: 100%; max-height: 350px; border-radius: 12px; margin-top: 10px; cursor: pointer; }
        #input-zone { padding: 20px; background-color: var(--sidebar-bg); display: flex; gap: 15px; align-items: center; border-top: 1px solid #333; }
        .controls-group { display: flex; flex-direction: column; gap: 5px; width: 200px; }
        .btn-icon { background: #373a40; color: #ccc; border: none; width: 45px; height: 45px; border-radius: 8px; font-size: 1.2em; cursor: pointer;}
        #txtInput { height: 50px; margin-bottom: 0; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>Cr√©ation de Personnage</h3>
        <div class="create-form">
            <input type="text" id="newCharName" placeholder="Nom du personnage">
            <input type="text" id="newCharAvatar" placeholder="URL Image (Optionnel)">
            <input type="color" id="newCharColor" value="#5c7cfa" style="height:30px; padding:0;">
            <button onclick="createCharacter()" class="btn-primary">Cr√©er le Perso</button>
        </div>
        <hr style="border:0; border-top:1px solid #333; margin: 20px 0;">
        <h3>Personnages (Monde)</h3>
        <div id="myCharList" style="overflow-y: auto; flex:1;"></div>
    </div>

    <div id="chat-area">
        <div id="messages"></div>
        <div id="input-zone">
            <div class="controls-group">
                <select id="charSelector"><option value="Narrateur">Narrateur</option></select>
                <input type="text" id="targetInput" placeholder="@ Public (ou nom du perso)" style="margin:0; padding: 8px; font-size:0.8em;">
            </div>
            <button class="btn-icon" onclick="askForImage()">üì∑</button>
            <input id="txtInput" type="text" autocomplete="off" placeholder="√âcrivez votre RP..." />
            <button class="btn-icon" onclick="sendMessage()" style="background: var(--accent-color); color:white;">‚û§</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        let myCharacters = [];

        // --- 1. INITIALISATION (R√©ception depuis la DB) ---
        socket.on('init_data', (data) => {
            // On charge l'historique
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = ""; // On vide pour √©viter les doublons
            data.messages.forEach(msg => displayMessage(msg));

            // On charge les personnages
            myCharacters = data.characters;
            updateUI();
            
            scrollToBottom();
        });

        // --- 2. GESTION PERSOS ---
        function createCharacter() {
            const name = document.getElementById('newCharName').value.trim();
            const color = document.getElementById('newCharColor').value;
            let avatar = document.getElementById('newCharAvatar').value.trim();
            if(!avatar) avatar = `https://ui-avatars.com/api/?name=${name}&background=random`;

            if(!name) return;

            // On envoie la demande au serveur
            socket.emit('create_char', { name, color, avatar });
            
            document.getElementById('newCharName').value = '';
            document.getElementById('newCharAvatar').value = '';
        }

        socket.on('new_char_created', (char) => {
            myCharacters.push(char);
            updateUI();
        });
        
        // Suppression
        function deleteCharacter(name) {
             if(confirm("Supprimer d√©finitivement " + name + " pour tout le monde ?")) {
                 socket.emit('delete_char', name);
             }
        }
        
        socket.on('char_deleted', (name) => {
            myCharacters = myCharacters.filter(c => c.name !== name);
            updateUI();
        });

        function updateUI() {
            const list = document.getElementById('myCharList');
            const select = document.getElementById('charSelector');
            const currentSelection = select.value; // On m√©morise la s√©lection

            list.innerHTML = "";
            select.innerHTML = '<option value="Narrateur" data-color="#ffffff" data-avatar="https://cdn-icons-png.flaticon.com/512/1144/1144760.png">Narrateur</option>';

            myCharacters.forEach(char => {
                // Sidebar
                list.innerHTML += `
                    <div class="char-item">
                        <img src="${char.avatar}" class="mini-avatar">
                        <div style="flex:1; color:${char.color}; font-weight:bold;">${char.name}</div>
                        <button style="background:none; border:none; color:#ff6b6b; cursor:pointer;" onclick="deleteCharacter('${char.name}')">‚úï</button>
                    </div>`;
                
                // Select
                const option = document.createElement("option");
                option.value = char.name;
                option.text = char.name;
                option.dataset.color = char.color;
                option.dataset.avatar = char.avatar;
                select.appendChild(option);
            });
            
            // Si le perso s√©lectionn√© existe encore, on le remet
            if (currentSelection === "Narrateur" || myCharacters.some(c => c.name === currentSelection)) {
                select.value = currentSelection;
            }
        }

        // --- 3. ENVOI / RECEPTION ---
        function sendMessage() {
            const textInput = document.getElementById('txtInput');
            const targetInput = document.getElementById('targetInput');
            if (textInput.value.trim() === "") return;

            const selector = document.getElementById('charSelector');
            const selectedOption = selector.options[selector.selectedIndex];
            
            const msgData = {
                content: textInput.value,
                type: "text",
                senderName: selectedOption.value,
                senderColor: selectedOption.dataset.color || "#ffffff",
                senderAvatar: selectedOption.dataset.avatar || "https://cdn-icons-png.flaticon.com/512/1144/1144760.png",
                targetName: targetInput.value.trim(),
                date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            socket.emit('message_rp', msgData);
            textInput.value = '';
        }
        
        function askForImage() {
            const url = prompt("URL de l'image :");
            if(url) {
                const selector = document.getElementById('charSelector');
                const selectedOption = selector.options[selector.selectedIndex];
                const msgData = {
                    content: url, type: "image",
                    senderName: selectedOption.value,
                    senderColor: selectedOption.dataset.color || "#ffffff",
                    senderAvatar: selectedOption.dataset.avatar,
                    targetName: document.getElementById('targetInput').value.trim(),
                    date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };
                socket.emit('message_rp', msgData);
            }
        }

        document.getElementById("txtInput").addEventListener("keyup", function(e) { if (e.key === "Enter") sendMessage(); });

        socket.on('message_rp', function(msg) {
            // Filtrage MP
            const isPublic = !msg.targetName || msg.targetName === "";
            // Est-ce pour moi (un de mes persos ?) -> ICI tous les persos sont partag√©s donc "Pour moi" veut dire "Est-ce que j'incarne ce perso ?"
            // Pour simplifier dans cette version partag√©e : On affiche tout ce qui est public, 
            // ET les MP si je suis l'exp√©diteur OU le destinataire (Nom exact).
            
            // Note : Comme on n'a pas de login, on ne peut pas savoir VRAIMENT qui est qui.
            // Donc pour les MP, on affiche tout, mais on met le style visuel "Priv√©". 
            // Pour un vrai syst√®me priv√©, il faudrait des comptes utilisateurs.
            
            displayMessage(msg);
            scrollToBottom();
        });

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            
            const isPrivate = msg.targetName && msg.targetName !== "";
            div.className = isPrivate ? 'message private-msg' : 'message';
            
            let contentHtml = msg.type === "image" ? 
                `<img src="${msg.content}" class="chat-image" onclick="window.open(this.src)">` : 
                `<div class="text-body">${msg.content}</div>`;

            let privateBadge = isPrivate ? `<span class="private-badge">üîí Priv√© avec ${msg.targetName}</span>` : "";

            div.innerHTML = `
                <img src="${msg.senderAvatar}" class="avatar-img">
                <div class="message-content">
                    <div class="char-header">
                        <span class="char-name" style="color: ${msg.senderColor}">${msg.senderName}</span>
                        <span class="timestamp">${msg.date}</span>
                        ${privateBadge}
                    </div>
                    ${contentHtml}
                </div>
            `;
            messagesDiv.appendChild(div);
        }

        function scrollToBottom() {
            const d = document.getElementById('messages');
            d.scrollTop = d.scrollHeight;
        }
    </script>
</body>
</html>
